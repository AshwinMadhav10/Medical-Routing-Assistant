<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medical AI Assistant</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #ecfdf5; /* light emerald */
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .app {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      padding: 16px;
    }

    .chat-card {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 18px 50px rgba(16, 185, 129, 0.25); /* emerald shadow */
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #059669, #10b981); /* emerald gradient */
      color: #ffffff;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .chat-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-header-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      background: rgba(255, 255, 255, 0.12);
    }

    .chat-header-main {
      display: flex;
      align-items: center;
    }

    .chat-header-right {
      font-size: 20px;
      opacity: 0.8;
    }

    .chat-box {
      padding: 14px 12px 8px;
      height: 420px;
      overflow-y: auto;
      background: #f0fdf4; /* very light emerald */
    }

    .msg-row {
      display: flex;
      margin-bottom: 10px;
      align-items: flex-end;
      gap: 6px;
    }

    .msg-row.bot {
      justify-content: flex-start;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-line;
    }

    .msg-row.bot .bubble {
      background: #ffffff;
      border-radius: 18px 18px 18px 6px;
      border: 1px solid #a7f3d0; /* emerald border */
      color: #111827;
    }

    .msg-row.user .bubble {
      background: #10b981; /* emerald */
      border-radius: 18px 18px 6px 18px;
      color: #ffffff;
    }

    .avatar-circle {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }

    .avatar-bot {
      background: #d1fae5;
      color: #047857;
    }

    .avatar-user {
      background: #10b981;
      color: #ffffff;
    }

    .input-area {
      border-top: 1px solid #e5e7eb;
      padding: 10px 10px 12px;
      background: #ffffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f9fafb;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #e5e7eb;
    }

    #prompt {
      border: none;
      outline: none;
      flex: 1;
      font-size: 14px;
      background: transparent;
      padding: 6px 0;
    }

    .icon-btn {
      border: none;
      outline: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .icon-btn.mic {
      color: #059669; /* emerald */
    }

    .icon-btn.mic.recording {
      color: #ef4444; /* red when recording */
      animation: pulse 1s infinite;
    }

    .send-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 8px 14px;
      background: #10b981; /* emerald */
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .send-btn:active {
      transform: translateY(1px);
    }

    .tts-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #047857; /* dark emerald */
      margin-left: 2px;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.5;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Scrollbar */
    .chat-box::-webkit-scrollbar {
      width: 5px;
    }

    .chat-box::-webkit-scrollbar-thumb {
      background: #6ee7b7; /* emerald light */
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="chat-card">
      <div class="chat-header">
        <div class="chat-header-main">
          <div class="chat-header-icon">
            ðŸ©º
          </div>
          <div class="chat-header-left">
            <div class="chat-header-title">Medical AI Assistant</div>
          </div>
        </div>
        <div class="chat-header-right">â‹®</div>
      </div>

      <div id="chat-box" class="chat-box">
        <!-- Messages will be injected here -->
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <button id="micBtn" class="icon-btn mic" title="Record voice">
            ðŸŽ¤
          </button>
          <input
            id="prompt"
            type="text"
            placeholder="Describe your symptoms..."
            autocomplete="off"
          />
        </div>
        <button id="sendBtn" class="send-btn">
          <span>Send</span>
          <span>âž¤</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const promptInput = document.getElementById("prompt");
    const sendBtn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");

    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // Add a message bubble to the chat
    function addMessage(text, sender, options = {}) {
      const { withVoiceButton = false } = options;

      const row = document.createElement("div");
      row.className = `msg-row ${sender}`;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      if (sender === "bot") {
        const avatar = document.createElement("div");
        avatar.className = "avatar-circle avatar-bot";
        avatar.textContent = "ðŸ©º";
        row.appendChild(avatar);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
        const avatar = document.createElement("div");
        avatar.className = "avatar-circle avatar-user";
        avatar.textContent = "ðŸ™‚";
        row.appendChild(avatar);
      }

      // âœ… Option A: keep a TTS button for EVERY bot message, do NOT remove old ones
      if (sender === "bot" && withVoiceButton) {
        const ttsBtn = document.createElement("button");
        ttsBtn.className = "tts-btn";
        ttsBtn.innerHTML = "ðŸ”Š";
        ttsBtn.title = "Play response audio";

        // Right now backend /text_to_speech always plays the latest llm_answer
        // So all buttons will play the latest answer (backend logic).
        ttsBtn.addEventListener("click", playTTS);

        row.appendChild(ttsBtn);
      }

      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
      return row;
    }

    // Helper for adding bot messages with TTS
    function addBotMessage(text) {
      addMessage(text, "bot", { withVoiceButton: true });
    }

    // Send text prompt to /model
    async function sendPrompt() {
      const prompt = promptInput.value.trim();
      if (!prompt) return;

      addMessage(prompt, "user");
      promptInput.value = "";

      const formData = new FormData();
      formData.append("prompt", prompt);

      try {
        const res = await fetch("/model", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || "Server error");
        }

        const reply = await res.text();
        addBotMessage(reply);
      } catch (err) {
        addMessage("Error: " + err.message, "bot");
      }
    }

    sendBtn.addEventListener("click", sendPrompt);
    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendPrompt();
      }
    });

    // ðŸŽ¤ Voice recording via mic button
    micBtn.addEventListener("click", async () => {
      if (!isRecording) {
        // Start recording
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });

          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (e) => {
            audioChunks.push(e.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            sendVoiceToBackend(audioBlob);
          };

          mediaRecorder.start();
          isRecording = true;
          micBtn.classList.add("recording");
        } catch (err) {
          addMessage("Microphone error: " + err.message, "bot");
        }
      } else {
        // Stop recording
        mediaRecorder.stop();
        isRecording = false;
        micBtn.classList.remove("recording");
      }
    });

    // Send recorded audio to /speech
    async function sendVoiceToBackend(blob) {
      // This is a temporary status message, so NO TTS button here
      const statusRow = addMessage("ðŸŽ¤ Processing voice...", "bot", {
        withVoiceButton: false,
      });

      const formData = new FormData();
      formData.append("voice", blob, "recording.webm");

      try {
        const res = await fetch("/speech", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || "Server error");
        }

        const data = await res.json();

        // Remove "Processing voice..." message
        statusRow.remove();

        // Show transcription as user's message (NO voice button)
        if (data.transcription) {
          addMessage("You said: " + data.transcription, "user");
        }

        // Show model response with voice button (Option A)
        if (data.model_response) {
          addBotMessage(data.model_response);
        }
      } catch (err) {
        statusRow.querySelector(".bubble").textContent =
          "Error: " + err.message;
      }
    }

    // ðŸ”Š Call /text_to_speech and play latest LLM answer
    async function playTTS() {
      try {
        const res = await fetch("/text_to_speech", {
          method: "POST",
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || "TTS failed");
        }

        const blob = await res.blob();
        const audioURL = URL.createObjectURL(blob);
        const audio = new Audio(audioURL);
        audio.play();
      } catch (err) {
        addMessage("TTS error: " + err.message, "bot");
      }
    }

    // Initial welcome message (also with ðŸ”Š, Option A)
    window.addEventListener("load", () => {
      addBotMessage(
        "Hi! I'm your medical assistant. Tell me your symptoms or tap the mic to speak."
      );
    });
  </script>
</body>
</html>
